# Архитектура деплоймента (Централизованный прокси)

## Топология

```
                    Internet (80, 443)
                            |
                            v
                    Node1 (136.112.81.235)
                    +----------------+
                    |    Node1       |
                    | nginx-proxy    | <-- Единая точка входа
                    | agent-service  |
                    | redis :6379    | <-- Кэш-сервер
                    +----------------+
                         |  |  |
         +---------------+  |  +----------------+
         |                  |                   |
         v                  v                   v
    Node2 (34.56.9.133)  localhost        Node3 (35.232.171.222)
    +----------------+   (127.0.0.1)      +----------------+
    | neuroboss      |                    | rag-service    |
    | :1216          |                    | :15015         |
    +----------------+                    | minio :9000    |
                                          | chromadb :8000 |
                                          +----------------+
```

## Маршрутизация запросов

| URL Pattern     | Целевой сервис            | Нода  | Адрес                  |
|-----------------|---------------------------|-------|------------------------|
| `/api/rag/*`    | rag-service               | Node3 | 35.232.171.222:15015   |
| `/minio/*`      | minio                     | Node3 | 35.232.171.222:9000    |
| `/api/*`        | agent-service             | Node1 | 127.0.0.1:15011        |
| `/*`            | neuroboss-service (UI)    | Node2 | 34.56.9.133:1216       |
| `/health`       | nginx health check        | Node1 | -                      |

## Компоненты на каждой ноде

### Node1 (136.112.81.235) - Proxy + Agent + Redis
- **nginx-proxy** - централизованный обратный прокси (порты 80, 443)
- **agent-service** - основной API сервис (порт 15011)
- **redis** - сервер кэширования (порт 6379)

**Открытые порты**: 80, 443, 15011, 6379 (только для внутренней сети)

### Node2 (34.56.9.133) - Neuroboss
- **neuroboss-service** - UI и бэкенд (порт 1216)

**Открытые порты**: 1216

### Node3 (35.232.171.222) - RAG + Storage
- **rag-service** - RAG API (порт 15015)
- **minio** - S3-совместимое хранилище (порты 9000, 9001)
- **chromadb** - векторная БД (порт 8000)

**Открытые порты**: 15015, 9000, 9001, 8000

## Преимущества такой архитектуры

✅ **Единая точка входа** - все запросы идут через Node1:80/443  
✅ **Централизованное кэширование** - Redis доступен для всех сервисов  
✅ **Простая маршрутизация** - nginx распределяет по location  
✅ **Масштабируемость** - легко добавить реплики сервисов  
✅ **Безопасность** - внутренние сервисы можно закрыть файрволом (оставить доступ только с Node1)  
✅ **SSL Termination** - можно настроить HTTPS только на nginx  

## Деплой

```bash
cd /home/psychopanda/projects/infra-compose/deploy/ansible

# Проверка конфигурации
ansible-playbook -i inventory.ini playbook.yml --check

# Полный деплой на все ноды
ansible-playbook -i inventory.ini playbook.yml

# Деплой только на конкретную ноду
ansible-playbook -i inventory.ini playbook.yml --limit node1
```

## Проверка работоспособности

```bash
# Health check nginx
curl http://136.112.81.235/health

# Проверка agent-service через прокси
curl http://136.112.81.235/api/health

# Проверка rag-service через прокси
curl http://136.112.81.235/api/rag/health

# Проверка neuroboss UI
curl http://136.112.81.235/
```

## Безопасность (Опционально)

Для максимальной безопасности можно настроить файрвол так, чтобы:
- Node2 и Node3 принимали подключения только с IP Node1
- Внешний мир имел доступ только к Node1:80,443

```bash
# На Node2 и Node3:
ufw default deny incoming
ufw allow from 136.112.81.235  # Разрешить только с Node1
ufw allow 22  # SSH для администрирования
ufw enable
```
