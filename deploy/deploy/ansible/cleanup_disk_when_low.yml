---
- name: Cleanup disk space when usage is above threshold
  hosts: all
  become: yes
  vars:
    # trigger threshold in percent (integer). e.g. 85
    threshold_percent: 85
    # how much journal logs to keep (passed to journalctl --vacuum-size)
    journal_vacuum_size: "200M"
    # remove files from /tmp older than this (days)
    tmp_file_age_days: 7
    # truncate log files bigger than this (MB)
    max_log_size_mb: 100
    # if true, will run 'docker system prune -af --volumes' when docker binary present
    perform_docker_prune: true
    # remove compressed logs older than (days)
    remove_compressed_logs_older_days: 30

  tasks:
    - name: Check for partitions exceeding threshold
      shell: |
        df -P -x tmpfs -x devtmpfs | awk 'NR>1{gsub(/%/,"",$5); if($5>=ENVIRON["THRESH"]) print $5 "," $6}'
      args:
        executable: /bin/bash
      environment:
        THRESH: "{{ threshold_percent }}"
      register: high_usage
      changed_when: false

    - name: Debug - partitions above threshold
      debug:
        var: high_usage.stdout_lines

    - name: Skip cleanup when no partition is above threshold
      meta: end_play
      when: high_usage.stdout == ""

    - name: Start cleanup - apt autoremove/autoclean
      apt:
        autoremove: yes
        autoclean: yes
        update_cache: no
      register: apt_cleanup_result

    - name: Clear apt lists to free some space (will be repopulated on next apt update)
      file:
        path: /var/lib/apt/lists
        state: absent
      register: apt_lists_removed

    - name: Vacuum systemd journal (if journalctl exists)
      shell: journalctl --vacuum-size={{ journal_vacuum_size }}
      register: journal_vacuum
      ignore_errors: yes

    - name: Truncate large log files under /var/log
      shell: |
        find /var/log -type f -name '*.log' -size +{{ max_log_size_mb }}M -print0 | xargs -0 -r truncate -s 0
      args:
        executable: /bin/bash
      register: truncate_logs
      ignore_errors: yes

    - name: Remove compressed rotated logs older than configured days
      find:
        paths: /var/log
        patterns: "*.gz"
        age: "{{ remove_compressed_logs_older_days }}d"
        recurse: yes
      register: old_compressed_logs

    - name: Delete old compressed logs
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_compressed_logs.files }}"
      when: old_compressed_logs.matched > 0
      loop_control:
        label: "{{ item.path }}"
      ignore_errors: yes

    - name: Clean /tmp (remove files older than configured days)
      find:
        paths: /tmp
        age: "{{ tmp_file_age_days }}d"
        recurse: yes
      register: old_tmp_files

    - name: Delete old /tmp files
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_tmp_files.files }}"
      when: old_tmp_files.matched > 0
      loop_control:
        label: "{{ item.path }}"
      ignore_errors: yes

    - name: Check if docker binary exists
      stat:
        path: /usr/bin/docker
      register: docker_stat

    - name: Optionally run docker system prune (aggressive)
      shell: docker system prune -af --volumes
      when: docker_stat.stat.exists and perform_docker_prune | bool
      register: docker_prune
      ignore_errors: yes

    - name: Re-check disk usage after cleanup
      shell: df -h --output=source,pcent,target -x tmpfs -x devtmpfs
      register: df_after
      changed_when: false

    - name: Show disk usage after cleanup
      debug:
        var: df_after.stdout_lines

    - name: Summary of actions
      debug:
        msg: |
          Cleanup completed. apt_cleanup={{ apt_cleanup_result is defined }} apt_lists_removed={{ apt_lists_removed is defined }} journal_vacuum={{ journal_vacuum is defined }} truncate_logs={{ truncate_logs is defined }} docker_prune={{ docker_prune is defined }}

# End of playbook
